{# version 1.00, date 13/05/2016, auteur Matthieu Martins-Baltar #}
{% extends "InterventionBundle::layout.html.twig" %}

{% block title %}

    Demander une intervention - {{ parent() }}

{% endblock %}

{% block body %}
    <h2>Demande d'intervention</h2>
    {{ form(form) }}
{% endblock %}

{%block javascripts %}
    {{ parent() }}
    {{ parent() }}
    <script src="{{ asset("vendor/bootstrap-datepicker/dist/js/bootstrap-datepicker.js") }}"></script>
    <script src="{{ asset("vendor/bootstrap-datepicker/dist/locales/bootstrap-datepicker.fr.min.js") }}"></script>

    <script type="application/javascript">
        console.log('début du javascript de l\'ambiance');
        var addInterElt = document.createElement('a');
        addInterElt.id = 'add_intervention';
        buttonAddElement = document.createElement('button');
        buttonAddElement.className = 'btn btn-info';
        buttonAddElement.textContent = 'Ajouter une Intervention';
        addInterElt.appendChild(buttonAddElement);
        document.getElementById('demande_Intervention').appendChild(addInterElt);

        function displayTypeIntervention(e){
            var parNode = e.target;
            parNode = parNode.parentNode;
            parNode = parNode.parentNode;
            parNode = parNode.parentNode;
            var matClasElt = parNode.getElementsByClassName('form-group')[2];
            var matFriElt = parNode.getElementsByClassName('form-group')[3];
            var themElt = parNode.getElementsByClassName('form-group')[7];
            var lblMatElt = parNode.getElementsByTagName('label')[1];

            switch(e.target.value){
                case 'frim' :
                    $(matClasElt).fadeOut('slow');
                    $(matFriElt).fadeIn('medium');
                    $(themElt).fadeIn('fast');
                    $(lblMatElt).fadeOut('fast');
                    break;
                case 'pld' :
                    $(lblMatElt).fadeIn('fast');
                    $(matFriElt).fadeOut('slow');
                    $(matClasElt).fadeIn('medium');
                    $(themElt).fadeIn('fast');
                    break;

                case 'aut' :
                    $(lblMatElt).fadeOut('fast');
                    $(matClasElt).fadeOut('fast');
                    $(matFriElt).fadeOut('fast');
                    $(themElt).fadeIn('fast');
                    break;
            }
            e.stopImmediatePropagation();
        }


        function treatmentSelect(template){
            var choiceEtabElt = document.getElementsByTagName('select')[0];
            //console.log('template:'+ template.html());
            var type;
            switch(choiceEtabElt.value){
                case 'ens' :
                    type = document.querySelector('input[name="demande[Etablissement][typeEnseignement]"]:checked').value;
                    switch (type){
                        case 'elementaire':

                            console.log($(template).find('select:eq(1)'));
                            console.log($(template).find('select:eq(1)').find('option:eq(5)'));

                            for(i=0; i<$(template).find('select')[1].length; i++){
                                if(i<7 || i>15){
                                    $(template).find('select:eq(1)').find('option:eq(i)').disabled = true;
                                }
                                console.log('option ' + i + ': ' + $(template).find('select:eq(1)').find('option:eq(i)'));
                            }
                            break;
                    }
                    break;
                case 'centre' :
                    type = document.querySelector('input[name="demande[Etablissement][typeCentre]"]:checked').value;
                    break;
                case 'autre' :
                    type = document.querySelector('input[name="demande[Etablissement][typeAutreEtablissement]"]:checked').value;
                    break;
            }
        }

        $(document).ready(function() {

            // On récupère la balise <div> en question qui contient l'attribut « data-prototype » qui nous intéresse.
            var $container = $('div#demande_Intervention');

            // On définit un compteur unique pour nommer les champs qu'on va ajouter dynamiquement
            var index = $container.find(':input').length;

            // On ajoute un nouveau champ à chaque clic sur le lien d'ajout.
            $('#add_intervention').click(function(e) {
                addIntervention($container);
                e.preventDefault(); // évite qu'un # apparaisse dans l'URL
                return false;
            });


            // On ajoute un premier champ automatiquement s'il n'en existe pas déjà un (cas d'une nouvelle annonce par exemple).

            if (index == 0) {

                addIntervention($container);

            } else {

                // S'il existe déjà des catégories, on ajoute un lien de suppression pour chacune d'entre elles

                $container.children('div').each(function() {

                    addDeleteLink($(this));

                });

            }


            // La fonction qui ajoute un formulaire CategoryType

            function addIntervention($container) {
                // Dans le contenu de l'attribut « data-prototype », on remplace :
                // - le texte "__name__label__" qu'il contient par le label du champ
                // - le texte "__name__" qu'il contient par le numéro du champ

                var template = $container.attr('data-prototype')
                    .replace(/__name__label__/g, 'Intervention n°' + (index+1))
                    .replace(/__name__/g,        index)
                    ;


                // On crée un objet jquery qui contient ce template
                var $prototype = $(template);

                addDeleteLink($prototype);

                $container.append($prototype);
                $("#add_intervention").appendTo($container).css('margin-left', '80%');
                treatmentSelect($(template));
                $($prototype).children().find("select").on("change",displayTypeIntervention);
                // Enfin, on incrémente le compteur pour que le prochain ajout se fasse avec un autre numéro
                index++;
            }

            // La fonction qui ajoute un lien de suppression
            function addDeleteLink($prototype) {
                // Création du lien
                var $deleteLink = $('<a href="#" class="btn btn-danger">Supprimer</a>');
                // Ajout du lien
                $prototype.append($deleteLink);
                // Ajout du listener sur le clic du lien pour effectivement
                $deleteLink.click(function(e) {
                    $prototype.remove();
                    e.preventDefault(); // évite qu'un # apparaisse dans l'URL
                    return false;
                });
            }

        });
    </script>

    <script type="application/javascript">
        document.getElementById('demande_Etablissement_TypeGeneral').addEventListener('change',function(e){
            switch (e.target.value){
                case 'ens' :
                    keepInstitute();
                    $('.form-group:eq(8)').fadeIn("fast");
                    break;
                case 'centre' :
                    keepCenter();
                    $('.form-group:eq(8)').fadeOut("fast");
                    $('#demande_Etablissement_uai').val('');
                    break;
                case 'autre' :
                    keepOther();
                    $('.form-group:eq(8)').fadeOut("fast");
                    $('#demande_Etablissement_uai').val('');
                    break;
            }
        });

        function keepInstitute(){
            $(".form-group:eq(5)").fadeIn("medium").removeAttr("disabled");
            $(".form-group:eq(6)").fadeOut("slow").prop("disabled",true);
            $(".form-group:eq(7)").fadeOut("slow").prop("disabled",true);
        }

        function keepCenter(){
            $(".form-group:eq(7)").fadeIn("medium").removeAttr("disabled");
            $(".form-group:eq(5)").fadeOut("slow").prop("disabled",true);
            $(".form-group:eq(6)").fadeOut("slow").prop("disabled",true);

        }

        function keepOther(){
            $(".form-group:eq(6)").fadeIn("medium").removeAttr("disabled");
            $(".form-group:eq(5)").fadeOut("slow").prop("disabled",true);
            $(".form-group:eq(7)").fadeOut("slow").prop("disabled",true);
        }

        function verifyAll(e){
           // verifyNumber(e);
            verifyCP(e);
           // verifyMail(e);
            showUAI();
            if($('#demande_Etablissement_uai').val().trim())
                verifyUAI(e);

        }

        function verifyNumber(e){
            var re = /(0)[1-9][0-9]{8}/;
            if(!(re.test($('#demande_Contact_telFixe').value) && re.test($('#demande_Contact_telPortable').value))){
                e.preventDefault();
                e.stopPropagation();
                alert("Numéro de téléphone au mauvais format");
                $('#demande_Contact_telFixe').css('border-color', 'red');
                $('#demande_Contact_telPortable').css('border-color', 'red');
            }else{
                $('#demande_Contact_telFixe').removeAttr('border-color');
                $('#demande_Contact_telPortable').removeAttr('border-color');
            }
        }

        function verifyCP(e){

            if(!(/[0-9]{5}/.test($('#demande_Etablissement_adresse_codePostal').val()))){
                e.preventDefault();
                e.stopPropagation();
                $('#demande_Etablissement_adresse_codePostal').css('border-color', 'red');
                alert("Code Postal au mauvais format");
            }else
                $('#demande_Etablissement_adresse_codePostal').removeAttr('border-color');

        }

        function verifyMail(e){
            var re = /^(([^<>()\[\]\.,;:\s@\"]+(\.[^<>()\[\]\.,;:\s@\"]+)*)|(\".+\"))@(([^<>()[\]\.,;:\s@\"]+\.)+[^<>()[\]\.,;:\s@\"]{2,})$/i;
            if(!(re.test($('#demande_Etablissement_emails').val()) && re.test($('#demande_Contact_email').val()))){
                $('#demande_Etablissement_emails').css('border-color', 'red');
                $('#demande_Contact_email').css('border-color', 'red');
                alert("E-mail au mauvais format");
                e.preventDefault();
                e.stopPropagation();
            }
            else {
                $('#demande_Etablissement_emails').removeAttr('border-color');
                $('#demande_Contact_email').removeAttr('border-color');
            }

        }

        function verifyUAI(e){
            console.log(verifyCodeUai($('#demande_Etablissement_uai').val()));
            if(!verifyCodeUai($('#demande_Etablissement_uai').val())){
                e.stopPropagation();
                e.preventDefault();
                $('#demande_Etablissement_uai').css('border-color', 'red');
                alert("UAI au mauvais format, veuillez ne pas en indiquer si ce champs pose problème");
            }else{
                $('#demande_Etablissement_uai').removeAttr('border-color');
            }
        }

        function verifyCodeUai(codeUai){
            // alphabet pris en compte (23 lettres, sans I, O et Q)
             var alphabet = 'abcdefghijklmnopqrstuvwxyz';

            // On supprime les espaces et on met tout en minuscules
            var codeUaiPropre = codeUai.trim().toLowerCase();

            // On récupère les chiffres et les lettres dans des variables séparées
            var codeUaiPropreChiffres = codeUaiPropre.substring(0,7);
            var codeUaiPropreLettre = codeUaiPropre.substring(7);

            // Le rang de la lettre correspond au reste de la division par 23
            var rangCalcule = codeUaiPropreChiffres % 23 ;

            // On récupère la lettre calculée dans l'alphabet
            var lettreCalculee = alphabet[rangCalcule] ;
            console.log(alphabet[rangCalcule]);
            console.log(lettreCalculee);
            console.log(alphabet[rangCalcule] == lettreCalculee);

            // On compare la lettre du code UAI à la lettre calculée et on retourne TRUE ou FALSE
            return codeUaiPropreLettre == lettreCalculee;
        }

        document.addEventListener('submit',verifyAll);



        function construction(item) {
            var newLineElt = document.createElement('tr');
            var columnHeadElt = document.createElement('td');
            $(item.getElementsByTagName('label')[0]).detach().appendTo($(columnHeadElt));
            $(columnHeadElt).detach().appendTo($(newLineElt));
                while(item.getElementsByTagName('input').length > 0){
                    var columnElt = document.createElement('td');
                    var inputElt = item.getElementsByTagName('input')[0];
                    $(inputElt).detach().appendTo($(columnElt));
                    $(columnElt).detach().appendTo($(newLineElt));
                }

            $(newLineElt).detach().appendTo($(tblElt));
        }

        function constructHeader(item){
            var theadElt = document.createElement('thead');
            var newLineElt = document.createElement('tr');
            var columnHeadElt = document.createElement('th');
            columnHeadElt.textContent = '#';
            $(columnHeadElt).detach().appendTo($(newLineElt));
            while(item.length > 0){
                var columnElt = document.createElement('th');
                var inputElt = item[0];
                $(inputElt).detach().appendTo($(columnElt));
                $(columnElt).detach().appendTo($(newLineElt));
            }
            $(newLineElt).detach().appendTo($(theadElt));
            $(theadElt).detach().appendTo($(tblElt));
        }

        var tblElt = document.createElement('table');
        $(tblElt).addClass('table table-bordered table-striped');

        for(var i =0; i < document.getElementsByClassName('form-group form-group')[16].getElementsByClassName('form-group').length; i++){
            construction(document.getElementsByClassName('form-group form-group')[16].getElementsByClassName('form-group')[i]);
        }

        constructHeader(document.getElementsByClassName('form-group form-group')[16].getElementsByClassName('form-group')[0].getElementsByTagName('label'));


        $('#demande_jour').replaceWith($(tblElt));

        //document.getElementsByClassName('form-group form-group')[16]
        //initialisation
        $('.form-group:eq(8)').fadeOut("fast");
        switch($("#demande_Etablissement_TypeGeneral").val()){
            case 'ens' :
                keepInstitute();
                break;
            case 'centre' :
                keepCenter();
                break;
            case 'autre' :
                keepOther();
                break;
        }

        $('#demande_plageDate_debut').addClass('week-picker');
        $('#demande_plageDate_fin').addClass('week-picker');
        $(function() {
            var startDate;
            var endDate;

            var selectCurrentWeek = function() {
                window.setTimeout(function () {
                    $('.week-picker').find('.ui-datepicker-current-day a').addClass('ui-state-active')
                }, 1);
            }

            $('.week-picker').datepicker( {
                showOtherMonths: true,
                selectOtherMonths: true,
                language :'fr',
                onSelect: function(dateText, inst) {
                    var date = $(this).datepicker('getDate');
                    startDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay());
                    endDate = new Date(date.getFullYear(), date.getMonth(), date.getDate() - date.getDay() + 6);
                    var dateFormat = inst.settings.dateFormat || $.datepicker._defaults.dateFormat;
                    $('#startDate').text($.datepicker.formatDate( dateFormat, startDate, inst.settings ));
                    $('#endDate').text($.datepicker.formatDate( dateFormat, endDate, inst.settings ));

                    selectCurrentWeek();
                },
                beforeShowDay: function(date) {
                    var cssClass = '';
                    if(date >= startDate && date <= endDate)
                        cssClass = 'ui-datepicker-current-day';
                    return [true, cssClass];
                },
                onChangeMonthYear: function(year, month, inst) {
                    selectCurrentWeek();
                }
            });

            $('.week-picker .ui-datepicker-calendar tr').on('mousemove', function() { $(this).find('td a').addClass('ui-state-hover'); });
            $('.week-picker .ui-datepicker-calendar tr').on('mouseleave', function() { $(this).find('td a').removeClass('ui-state-hover'); });
        });

        $('.date-pick').datepicker();

    </script>

{% endblock %}
