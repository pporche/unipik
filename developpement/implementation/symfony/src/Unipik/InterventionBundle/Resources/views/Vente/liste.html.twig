{# version 1.00, date 22/11/2016, auteur Kafui Atanley #}

{% extends "InterventionBundle::layout.html.twig" %}

{% block title %}
    Liste des Ventes - {{ parent() }}

{% endblock %}

{% block stylesheets %}
    {{ parent() }}

    <link rel='stylesheet' href="{{ asset('css/twitterTypeahead.css') }}"/>

    <link rel="stylesheet" href="{{ asset("vendor/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css") }}"/>
    <link rel="stylesheet" href="{{ asset("vendor/chosen/chosen.css") }}"/>
    <link rel="stylesheet" href="{{ asset('vendor/leaflet/dist/leaflet.css') }}" />

    <style>
        #mapid {  height: 500px; }

        /* Style the list */
        ul.tab {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            border: 1px solid #ccc;
            background-color: #f1f1f1;
        }

        /* Float the list items side by side */
        ul.tab li {float: left;}

        /* Style the links inside the list items */
        ul.tab li a {
            display: inline-block;
            color: black;
            text-align: center;
            padding: 14px 16px;
            text-decoration: none;
            transition: 0.3s;
            font-size: 17px;
        }

        /* Change background color of links on hover */
        ul.tab li a:hover {background-color: #ddd;}

        /* Create an active/current tablink class */
        ul.tab li a:focus, .active {background-color: #ccc;}

        /* Style the tab content */
        .tabcontent {
            display: none;
            padding: 6px 12px;
            border: 1px solid #ccc;
            border-top: none;
        }

        #CAerrorIntervalle, #CAerrorType, #CAerrorChampsVide, #codeError, #villeError, #distanceError {
            font-size : 13px;
            font-style : italic;
            color : red;
        }

        .error {
            border: solid 2px #FF0000;
        }

        input[type="text"]{
            width: 140px;
        }

        #ville, #distanceKm, #filtrePar{
            margin-bottom: 15px;
        }
        #recherche_avancee_ville {
            text-transform: uppercase;
        }
        @media only screen and (max-width: 1000px) {
            /* Force table to not be like tables anymore */
            table,
            thead,
            tbody,
            th,
            td,
            tr {
                display: block;
            }

            /* Hide table headers (but not display: none;, for accessibility) */
            thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }

            tr {
                border: 1px solid #ccc;
            }

            td {
                /* Behave  like a "row" */
                border: none;
                border-bottom: 1px solid #eee;
                position: relative;
                padding-left: 50% !important;
                white-space: normal;
                text-align: left;
            }

            td:before {
                /* Now like a table header */
                position: absolute;
                /* Top/left values mimic padding */
                top: 6px;
                left: 6px;
                width: 45%;
                padding-right: 10px;
                white-space: nowrap;
                text-align: left;
                font-weight: bold;
            }

            /*
            Label the data
            */
            td:before {
                content: attr(data-title);
            }
        }
        .container{
            padding-right: 15px !important;
            padding-left: 20px !important;
        }
        tbody{
            font-size: 15px !important;
        }


        #tableVente {
            display:block;
            max-height: 58vh;
            overflow:auto;
        }
        #tableVente thead, #tableVente tr {
            display:table;
            width:100%;
            table-layout:fixed;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset("vendor/bootstrap-datepicker/dist/js/bootstrap-datepicker.js") }}"></script>
    <script src="{{ asset("vendor/bootstrap-datepicker/dist/locales/bootstrap-datepicker.fr.min.js") }}"></script>
    <script src="{{ asset("vendor/typeahead.js/dist/typeahead.jquery.js") }}"></script>
    <script src="{{ asset("vendor/typeahead.js/dist/bloodhound.js") }}"></script>
    <script src="{{ asset("vendor/chosen/chosen.jquery.js") }}"></script>
    <script src="{{ asset("vendor/pdfmake/build/pdfmake.min.js") }}"></script>
    <script src="{{ asset("vendor/pdfmake/build/vfs_fonts.js") }}"></script>
    <script src="{{ asset('vendor/leaflet/dist/leaflet.js') }}"></script>
    <script>
        $(document).ready(function () {
            openDisplay($('#Liste'), 'Liste');

            $("#CAerrorType").hide();
            $("#CAerrorIntervalle").hide();
            $("#CAerrorChampsVide").hide();
            $("#villeError").hide();
            $("#codeError").hide();
            $("#distanceError").hide();

            $('input:checkbox').removeAttr('checked');
            if($('#recherche_avancee_dansVilleOuParDistance_0').is(':checked')){
                $('#ville').show();
                $('#distanceKm').hide();
                $("#recherche_avancee_distance").val("");
                $('#distVilleOuDom').hide();
                $('#recherche_avancee_villeOuDomicile:first-child').hide();
            }else if ($('#recherche_avancee_dansVilleOuParDistance_1').is(':checked')){
                if($('#recherche_avancee_villeOuDomicile_0').is(':checked')){
                    $('#ville').show();
                    $('#distanceKm').show();
                    $('#recherche_avancee_villeOuDomicile div:first-child').hide();
                }else{
                    $('#ville').hide();
                    $('#distanceKm').show();
                    $('#recherche_avancee_villeOuDomicile div:first-child').hide();
                }
            }else {
                $('#ville').hide();
                $("#recherche_avancee_distance").val("");
                $('#distanceKm').hide();
                $('#distVilleOuDom').hide();
                $('#recherche_avancee_villeOuDomicile div:first-child').hide();
            }

            $('#recherche_avancee_villeOuDomicile div:first-child').hide();

            $('#myTable').pageMe({
                pagerSelector: '#myPager',
                showPrevNext: true,
                hidePageNumbers: false,
                perPage:{{ rowsPerPage }} });

            $("#recherche_avancee_date").prop('checked', true);
            $("#between_dates").hide();

            hide_or_show = function () {
                if ($(this).is(':checked')) {
                    $("#between_dates").hide();
                    $("#recherche_avancee_start").prop('required', false);
                    $("#recherche_avancee_end").prop('required', false);
                } else {
                    $("#between_dates").show();
                    $("#recherche_avancee_start").prop('required', true);
                    $("#recherche_avancee_end").prop('required', true);
                }
            };

            $("#recherche_avancee_date").change(hide_or_show);

            $('#recherche_avancee_start').datepicker({
                format: 'dd-mm-yyyy',
                language: 'fr',
                autoclose: true
            }).on('changeDate', function (selected) {
                $('#recherche_avancee_end').datepicker('setStartDate', new Date(selected.date.valueOf()));
            });
            $('#recherche_avancee_end').datepicker({
                format: 'dd-mm-yyyy',
                language: 'fr',
                autoclose: true
            }).on('changeDate', function (selected) {
                $('#recherche_avancee_start').datepicker('setEndDate', new Date(selected.date.valueOf()));
            });


            $('#recherche_avancee_dansVilleOuParDistance_placeholder').click(function() {
                if($('#recherche_avancee_dansVilleOuParDistance_placeholder').is(':checked')) {
                    $('#ville').hide();
                    $('#distanceKm').hide();
                    $('#distVilleOuDom').hide();
                    $('#recherche_avancee_villeOuDomicile_placeholder').prop('checked', true);
                    $('#recherche_avancee_ville').val('');
                    $('#recherche_avancee_villeOuDomicile div:first-child').prop('checked', true);
                    $("#recherche_avancee_distance").val("");
                }
            });

            $('#recherche_avancee_dansVilleOuParDistance_0').click(function() {
                if($('#recherche_avancee_dansVilleOuParDistance_0').is(':checked')) {
                    $('#ville').show();
                    $('#distanceKm').hide();
                    $('#distVilleOuDom').hide();
                    $('#recherche_avancee_villeOuDomicile_placeholder').prop('checked', true);
                    $('#recherche_avancee_ville').val('');
                    $('#recherche_avancee_villeOuDomicile div:first-child').prop('checked', true);
                    $("#recherche_avancee_distance").val("");
                }
            });

            $('#recherche_avancee_dansVilleOuParDistance_1').click(function() {
                if($('#recherche_avancee_dansVilleOuParDistance_1').is(':checked')) {
                    $('#distanceKm').show();
                    $('#ville').hide();
                    $('#distVilleOuDom').show();
                    $('#recherche_avancee_villeOuDomicile_placeholder').prop('checked', true);

                    $('#recherche_avancee_villeOuDomicile div:first-child').hide();
                    $('#recherche_avancee_villeOuDomicile_1').prop('checked', true);
                    $('#recherche_avancee_ville').val('');
                }
            });

            $('#recherche_avancee_villeOuDomicile_0').click(function() {
                if($('#recherche_avancee_villeOuDomicile_0').is(':checked')) {
                    $('#ville').show();
                    $('#recherche_avancee_ville').val('');
                }
            });

            $('#recherche_avancee_villeOuDomicile_1').click(function() {
                if($('#recherche_avancee_villeOuDomicile_1').is(':checked')) {
                    $('#ville').hide();
                    $('#recherche_avancee_ville').val('');
                }
            });

        });

        function verifyChampsVide(e){
            if (    ($('#recherche_avancee_CADebut').val() == "" && $('#recherche_avancee_CAFin').val() != "")
                ||  ($('#recherche_avancee_CADebut').val() != "" && $('#recherche_avancee_CAFin').val() == "") ) {
                e.preventDefault();
                e.stopPropagation();
                $('#CAerrorChampsVide').show();
                if ($('#recherche_avancee_CADebut').val() == null) {
                    $('#recherche_avancee_CADebut').addClass('error');
                }
                if ($('#recherche_avancee_CAFin').val() == null) {
                    $('#recherche_avancee_CAFin').addClass('error');
                }

                if ($('#recherche_avancee_CADebut').val() != null) {
                    $('#recherche_avancee_CADebut').removeClass('error');
                }
                if ($('#recherche_avancee_CAFin').val() != null) {
                    $('#recherche_avancee_CAFin').removeClass('error');
                }
            } else {
                $('#CAerrorChampsVide').hide();
                $('#recherche_avancee_CADebut').removeClass('error');
                $('#recherche_avancee_CAFin').removeClass('error');
            }
            if (($('#recherche_avancee_dansVilleOuParDistance_0').is(':checked') || ($('#recherche_avancee_dansVilleOuParDistance_1').is(':checked') && ($('#recherche_avancee_villeOuDomicile_0').is(':checked')))) && $('#recherche_avancee_ville').val().trim().length==0) {
                e.preventDefault();
                e.stopPropagation();
                $('#villeError').show();
                $('#recherche_avancee_ville').addClass('error');
            } else {
                $('#villeError').hide();
                $('#recherche_avancee_ville').removeClass('error');
            }
            if ($('#recherche_avancee_dansVilleOuParDistance_1').is(':checked') && $('#recherche_avancee_distance').val().trim().length==0) {
                e.preventDefault();
                e.stopPropagation();
                $('#distanceError').show();
                $('#recherche_avancee_distance').addClass('error');
            } else {
                $('#distanceError').hide();
                $('#recherche_avancee_distance').removeClass('error');
            }
        }

        function verifyCAType(e) {
            var re = /^([\d]+([.,][\d]+)?)?$/;
            //borne du début
            if (!re.test($('#recherche_avancee_CADebut').val()) || !re.test($('#recherche_avancee_CAFin').val())) {
                e.preventDefault();
                e.stopPropagation();
                $('#CAerrorType').show();
                if (!re.test($('#recherche_avancee_CADebut').val())) {
                    $('#recherche_avancee_CADebut').addClass('error');
                }
                if (!re.test($('#recherche_avancee_CAFin').val())) {
                    $('#recherche_avancee_CAFin').addClass('error');
                }
                if (re.test($('#recherche_avancee_CADebut').val())) {
                    $('#recherche_avancee_CADebut').removeClass('error');
                }
                if (re.test($('#recherche_avancee_CAFin').val())) {
                    $('#recherche_avancee_CAFin').removeClass('error');
                }
            } else {
                $('#CAerrorType').hide();
                $('#recherche_avancee_CADebut').removeClass('error');
                $('#recherche_avancee_CAFin').removeClass('error');
            }
        }

        function verifyCAIntervalle(e) {
            if (   !( ($('#recherche_avancee_CADebut').val() == "" && $('#recherche_avancee_CAFin').val() != "")
                ||  ($('#recherche_avancee_CADebut').val() != "" && $('#recherche_avancee_CAFin').val() == "") )) {
                if (parseInt($('#recherche_avancee_CADebut').val()) > parseInt($('#recherche_avancee_CAFin').val())) {
                    e.preventDefault();
                    e.stopPropagation();
                    $('#CAerrorIntervalle').show();
                    $('#recherche_avancee_CADebut').addClass('error');
                    $('#recherche_avancee_CAFin').addClass('error');
                } else {
                    $('#CAerrorIntervalle').hide();
                    $('#recherche_avancee_CADebut').removeClass('error');
                    $('#recherche_avancee_CAFin').removeClass('error');
                }
            }
        }

        function verifyCP(e){
            if ($('#recherche_avancee_ville').val().trim().length!=0 && $('#recherche_avancee_ville').val().indexOf(' (') < 0) {
                e.preventDefault();
                e.stopPropagation();
                $('#codeError').show();
                $('#recherche_avancee_ville').addClass('error');
            } else {
                $('#codeError').hide();
                $('#recherche_avancee_ville').removeClass('error');
            }
        }

        function geolocalisation(e) {
            if ($('#recherche_avancee_dansVilleOuParDistance_1').is(':checked') && $('#recherche_avancee_villeOuDomicile_0').is(':checked')) {
                var ville = $('#recherche_avancee_ville').val();
                var geolocalisation = '';
                $.get(location.protocol + '//nominatim.openstreetmap.org/search?format=json&q='+ville, function (dataVille) {
                    if (dataVille.length > 0) {
                        geolocalisation = 'SRID=4326;POINT(' + dataVille[0]['lon'] + ' ' + dataVille[0]['lat'] + ')';
                        $("#recherche_avancee_ville").val($("#recherche_avancee_ville").val().split(' (')[0]);
                        $("#recherche_avancee_geolocalisation").val(geolocalisation);
                    }
                    else {
                        //Que fait-on si 0 match ?
                        e.preventDefault();
                        e.stopPropagation();
                    }
                });
            }
        }

        function verifyAll(e) {
            verifyChampsVide(e);
            verifyCAType(e);
            verifyCAIntervalle(e);
            verifyCP(e);
            geolocalisation(e);
            $("#recherche_avancee_ville").val($("#recherche_avancee_ville").val().split(' (')[0]);
        }

        document.addEventListener('submit', verifyAll);

        function imprimer(){
            var docDefinition = {
                pageOrientation: 'portrait',
                content: [
                    {text: "Liste des ventes", style: ['header']},
                    {text: " ", style: ['header']},
                    {
                        style: 'table',
                        table: {
                            headerRows: 1,
                            widths: [130, 50,130, 100, 50],
                            body: [
                                [
                                    { text: 'Lieu', style: 'tableHeader' },
                                    { text: 'Date de la vente', style: 'tableHeader'},
                                    { text: 'Établissement', style: 'tableHeader' },
                                    { text: 'Intervention liée', style: 'tableHeader' },
                                    { text: 'Chiffre d\'affaire', style: 'tableHeader' }
                                ],
                                {% for vente in ventes %}
                                [ { text: "{{ vente.etablissement.adresse.ville.nom }}", style: 'tableHeader' },
                                    { text: "{{ vente.dateVente|date('d-m-Y') }}", style: 'tableHeader' },
                                    { text: "{{ vente.etablissement.nom | capitalize }}", style: 'tableHeader' },
                                    {% if vente.intervention %}
                                    { text: "FRIMOUSSE A L'{{ vente.intervention.etablissement.nom | capitalize }}", style: 'tableHeader' },
                                    {% else %}
                                    { text: "-", style: 'tableHeader' },
                                    {% endif %}
                                    { text: "{{ vente.chiffreAffaire }} €", style: 'tableHeader' },
                                ],
                                {% endfor %}
                            ]
                        },
                        layout: 'lightHorizontalLines'
                    }
                ],
                styles: {
                    header: {
                        fontSize: 13,
                        alignment: 'center'
                    },
                    tableHeader: {
                        fontSize: 9,
                        alignment: 'left'
                    }
                }
            };

            pdfMake.createPdf(docDefinition).open('pdf/test','name',null,false);
        }

        function deleteVentes() {
            var conf = confirm('Souhaitez vous vraiment supprimer ces ventes ?');

            if (conf) {
                var selected = [];
                $("input:checkbox[name=type]:checked").each(function () {
                    var $this = $(this);
                    selected.push($this.attr("id"));
                });
                var ids = JSON.stringify(selected);
                $.post("{{ path('vente_admin_deletes') }}", {'ids': ids},
                    function (data, status) {
                        for (i = 0; i < selected.length; i++) {
                            $("#" + selected[i]).closest('tr').remove();
                        }
                    });
            }
        }

        var villes = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            //prefetch: '{{ path("architecture_ville_autocomplete") }}',
            remote: {
                url: '{{ path("architecture_ville_autocomplete") }}?term=%QUERY',
                wildcard: '%QUERY'
            }
        });

        $('#recherche_avancee_ville').typeahead(null, {
            name: 'villes',
            source: villes,
            limit: 50
        });

        function openDisplay(button, display) {
            // Declare all variables
            var i, tabcontent, tablinks;

            // Get all elements with class="tabcontent" and hide them
            tabcontent = document.getElementsByClassName("tabcontent");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].style.display = "none";
            }

            // Get all elements with class="tablinks" and remove the class "active"
            tablinks = document.getElementsByClassName("tablinks");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].className = tablinks[i].className.replace(" active", "");
            }

            // Show the current tab, and (not done anymore ->) add an "active" class to the link that opened the tab
            document.getElementById(display).style.display = "block";
            button.className += " active";
        }

        {% if ventes is not empty %}
            var mymap = L.map('mapid');
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
                maxZoom: 20,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);
            var markers = [];
            {% for vente in ventes %}
                var lat = {{ vente.etablissement.adresse.geolocalisation|split('(')[1]|split(' ')[0] }};
                var lon = {{ vente.etablissement.adresse.geolocalisation|split(' ')[1]|split(')')[0] }};
                var marker = L.marker([lon, lat]).bindPopup("<b>{{ vente.etablissement.nom }}</b><br>{{ vente.etablissement.adresse.ville.nom }}<br><a href='{{ path('vente_view', {id: vente.id}) }}'>Détails de la vente</a>");
                marker.on('click', function (e) {
                    mymap.setView(e.target.getLatLng());
                });
                markers.push(marker);
            {% endfor %}
            var group = new L.featureGroup(markers).addTo(mymap);
            mymap.fitBounds(group.getBounds());
            mymap.setZoom(9);

            $("body").on('click','#CarteLink', function() {
                mymap.invalidateSize(false);
            });
        {% endif %}
    </script>
{% endblock %}

{% block body %}

    {% if venteInterventionListe %}
        {% set vue =  'vente_intervention' %}
        {% set param =   interventionId  %}
    {% elseif venteEtablissementListe  %}
        {% set vue =  'vente_etablissement' %}
        {% set param =   etablissementId  %}
    {% else %}
        {% set vue =  'vente_list' %}
        {% set param =  null %}
    {% endif %}
    <section class="col-lg-2 col-md-2 col-sm-2">
        <div class="row">
            <div class='well'>
                {% if venteInterventionListe %}
                    {{ form_start(form, {'method': 'get', 'action': path('vente_intervention', {'id': interventionId}), 'attr': {'class': 'vente form-sm'}}) }}
                {% elseif venteEtablissementListe  %}
                    {{ form_start(form, {'method': 'get', 'action': path('vente_etablissement', {'id': etablissementId}), 'attr': {'class': 'vente form-sm'}}) }}
                {% else %}
                    {{ form_start(form, {'method': 'get', 'action': path('vente_list'), 'attr': {'class': 'vente form-sm'}}) }}
                {% endif %}
                <h5>Dates de vente :</h5>
                {{ form_widget(form.date) }}
                <div id="between_dates">
                    Ventes entre le
                    {{ form_widget(form.start, { 'attr': {'class': 'input-sm'} }) }}
                    et le
                    {{ form_widget(form.end, { 'attr': {'class': 'input-sm'} }) }}
                </div>
                <br/>
                <div id="filtrePar">
                    <h5> Filtre par lieu :</h5>
                    {{ form_widget(form.dansVilleOuParDistance) }}
                </div>
                <div id="distVilleOuDom">
                    <h5> Distance de ville ou domicile ?</h5>
                    {{ form_widget(form.villeOuDomicile) }}
                </div>
                <div id="ville">
                    <h5> Ville :</h5>
                    {{ form_widget(form.ville, { 'attr': {'class': 'input-sm'} }) }}
                </div>
                <div id="villeError">
                    Ce champ est obligatoire
                </div>
                <div id="codeError">
                    Sélectionnez un code postal
                </div>
                <div id="distanceKm">
                    <h5> Distance en km :</h5>
                    {{ form_widget(form.distance) }}
                </div>
                <div id="distanceError">
                    Ce champ est obligatoire
                </div>
                <br/>
                <div id="CA">
                    <h5> Chiffre d'affaire entre :</h5>
                    {{ form_widget(form.CADebut, { 'attr': {'class': 'input-sm'} }) }} et {{ form_widget(form.CAFin, { 'attr': {'class': 'input-sm'} }) }}
                    <div id="CAerrorChampsVide">Les deux champs doivent être remplis</div>
                    <div id="CAerrorType">Les champs doivent contenir des nombres</div>
                    <div id="CAerrorIntervalle">Le premier champ doit être inférieur au deuxième</div>
                </div>
                <div>
                    <input type="submit" value="OK" class="btn btn-primary"/>
                </div>
            </div>
            {{ form_end(form) }}
        </div>
    </section>
    <section id="listeVente" class="col-lg-10 col-md-10 col-sm-10">
        <ul class="tab">
            <li><a href="javascript:void(0)" class="tablinks" id="ListeLink" onclick="openDisplay($(this), 'Liste')">Liste</a></li>
            <li><a href="javascript:void(0)" class="tablinks" id="CarteLink" onclick="openDisplay($(this), 'Carte')">Carte</a></li>
        </ul>
        <div id="Liste" class="tabcontent">
            {% if ventes is not empty %}
            <h2> Liste des Ventes : </h2>
            <button type="button" class="imprimente" onclick="imprimer()"><span class="glyphicon glyphicon-print"></span></button><br>

            <div class="container">
                <div class="row">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover" id="tableVente">
                            <thead>
                            <tr>
                                {% set pathReq = app.request.attributes.get('_route_params') %}
                                {% if app.request.query.get('recherche_avancee') is not null %}
                                    {% set pathReq = pathReq | merge({"recherche_avancee":app.request.query.get('recherche_avancee')}) %}
                                {% endif %}
                                {% if app.request.query.get('rowsPerPage') is not null %}
                                    {% set pathReq = pathReq | merge({"rowsPerPage":app.request.query.get('rowsPerPage')}) %}
                                {% endif %}

                                {% if field == "dateVente" %}
                                    {% if desc %}
                                        <th> Lieu
                                            <a class="sortButtonLieu" id="sortButtonLieu"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"lieu"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortLieu" alt="sort Down"/>
                                            </a></th>
                                        <th> Date de la vente
                                            <a class="sortButtonDate" id="sortButtonDate"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"dateVente"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class=" sort sort-down"
                                                     id="sortDate" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th> Etablissement </th>
                                        <th> Intervention liée </th>
                                        <th>  Chiffre d'affaire
                                            <a class="sortButtonCA" id="sortButtonCA"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"CA"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortCA" alt="sort Down"/>
                                            </a></th>
                                    {% else %}
                                        <th>Lieu
                                            <a class="sortButtonLieu" id="sortButtonLieu"
                                               href="{{ path(vue, pathReq | merge({"desc":true, "field":"lieu"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-up"
                                                     id="sortLieu" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th> Date de la vente
                                            <a class="sortButtonDate" id="sortButtonDate"
                                               href="{{ path(vue,  pathReq| merge({"desc":true, "field":"dateVente"}) ) }}">
                                                <img src="{{ asset('img/sort-up.png') }}" class=" sort sort-up"
                                                     id="sortDate" alt="sort Up"/>
                                            </a>
                                        </th>
                                        <th> Etablissement </th>
                                        <th> Intervention liée </th>
                                        <th>  Chiffre d'affaire
                                            <a class="sortButtonCA" id="sortButtonCA"
                                               href="{{ path(vue, pathReq | merge({"desc":true, "field":"CA"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortCA" alt="sort Down"/>
                                            </a></th>
                                    {% endif %}
                                {% elseif field == "lieu" %}
                                    {% if desc %}
                                        <th>Lieu
                                            <a class="sortButtonLieu" id="sortButtonLieu"
                                               href="{{ path(vue,pathReq | merge({"desc":false, "field":"lieu"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortLieu" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th>Date de la vente
                                            <a class="sortButtonDate" id="sortButtonDate"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"dateVente"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class=" sort sort-down"
                                                     id="sortDate" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th> Etablissement </th>
                                        <th> Intervention liée </th>
                                        <th>  Chiffre d'affaire
                                            <a class="sortButtonCA" id="sortButtonCA"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"CA"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortCA" alt="sort Down"/>
                                            </a></th>
                                    {% else %}
                                        <th>Lieu
                                            <a class="sortButtonLieu" id="sortButtonLieu"
                                               href="{{ path(vue,  pathReq | merge({"desc":true, "field":"lieu"}) ) }}">
                                                <img src="{{ asset('img/sort-up.png') }}" class="sort sort-up" id="sortLieu"
                                                     alt="sort Up"/>
                                            </a>
                                        </th>
                                        <th>Date de la vente
                                            <a class="sortButtonDate" id="sortButtonDate"
                                               href="{{ path(vue,  pathReq | merge({"desc":true, "field":"dateVente"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class=" sort sort-up"
                                                     id="sortDate" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th> Etablissement </th>
                                        <th> Intervention liée </th>
                                        <th>  Chiffre d'affaire
                                            <a class="sortButtonCA" id="sortButtonCA"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"CA"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortCA" alt="sort Down"/>
                                            </a></th>
                                    {% endif %}
                                {% elseif field == "CA" %}
                                    {% if desc %}
                                        <th>Lieu
                                            <a class="sortButtonLieu" id="sortButtonLieu"
                                               href="{{ path(vue,pathReq | merge({"desc":false, "field":"lieu"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortLieu" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th>Date de la vente
                                            <a class="sortButtonDate" id="sortButtonDate"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"dateVente"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class=" sort sort-down"
                                                     id="sortDate" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th> Etablissement </th>
                                        <th> Intervention liée </th>
                                        <th>  Chiffre d'affaire
                                            <a class="sortButtonCA" id="sortButtonCA"
                                               href="{{ path(vue, pathReq | merge({"desc":false, "field":"CA"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortCA" alt="sort Down"/>
                                            </a></th>
                                    {% else %}
                                        <th>Lieu
                                            <a class="sortButtonLieu" id="sortButtonLieu"
                                               href="{{ path(vue,pathReq | merge({"desc":false, "field":"lieu"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class="sort sort-down"
                                                     id="sortLieu" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th>Date de la vente
                                            <a class="sortButtonDate" id="sortButtonDate"
                                               href="{{ path(vue,  pathReq | merge({"desc":true, "field":"dateVente"}) ) }}">
                                                <img src="{{ asset('img/sort-down.png') }}" class=" sort sort-up"
                                                     id="sortDate" alt="sort Down"/>
                                            </a>
                                        </th>
                                        <th> Etablissement </th>
                                        <th> Intervention liée </th>
                                        <th>  Chiffre d'affaire
                                            <a class="sortButtonCA" id="sortButtonCA"
                                               href="{{ path(vue,  pathReq | merge({"desc":true, "field":"CA"}) ) }}">
                                                <img src="{{ asset('img/sort-up.png') }}" class="sort sort-up" id="sortCA"
                                                     alt="sort Up"/>
                                            </a></th>
                                    {% endif %}
                                {% endif %}

                                <th>Voir détails</th>
                                {% if is_granted('ROLE_ADMIN') %}
                                    <th>Supprimer</th>
                                {% endif %}
                            </tr>
                            </thead>
                            <tbody id="myTable">
                            {% if ventes is not empty %}
                                {% for vente in ventes %}
                                    <tr>
                                        <td data-title="Lieu">{{ vente.etablissement.adresse.ville.nom }}</td>
                                        <td data-title="Date Vente">{{ vente.dateVente|date("d-m-Y") }}</td>
                                        <td data-title="Etablissement">
                                            <a href="{{ path('etablissement_view', {'id':vente.etablissement.id}) }}">
                                                {{ vente.etablissement.nom | capitalize}}
                                            </a>
                                        </td>
                                        <td data-title="Intervention liée">
                                            {% if vente.intervention %}
                                                <a href="{{ path('intervention_view', {'id':vente.intervention.id}) }}">
                                                    Frimousse à l'{{ vente.intervention.etablissement.nom | lower}}
                                                </a>
                                            {% else %}
                                                <div style="text-align: center"> - </div>
                                            {% endif %}
                                        </td>
                                        <td data-title="Chiffre Affaire" style="text-align: center"> {{ vente.chiffreAffaire }} € </td>
                                        <td data-title="Voir Détails">
                                            <a href="{{ path('vente_view', {id: vente.id}) }}"
                                               class="btn btn-primary">Voir détails</a>
                                        </td>
                                        {% if is_granted('ROLE_ADMIN') %}
                                            <td data-title="Supprimer">
                                                <div class="checkbox" style="text-align: center">
                                                    <label>
                                                        <input type="checkbox" name="type" id="{{ vente.id }}">
                                                    </label>
                                                </div>
                                            </td>
                                        {% endif %}
                                    </tr>
                                {% endfor %}
                            {% endif %}
                            </tbody>
                        </table>
                    </div>
                    <div class="buttons">
                        {% if is_granted('ROLE_ADMIN') %}
                            <button type="button" class="btn btn-danger" onclick="deleteVentes()">Supprimer</button>
                        {% endif %}
                    </div>
                    <div class="col-md-12 text-center">
                        {% set pathReq = [] %}
                        {% if app.request.query.get('recherche_avancee') is not null %}
                            {% set pathReq = {"recherche_avancee":app.request.query.get('recherche_avancee')} %}
                        {% endif %}
                        {% if app.request.query.get('desc') is not null %}
                            {% set pathReq = pathReq | merge({"desc":app.request.query.get('desc')}) | merge({"field":app.request.query.get('field')}) %}
                        {% endif %}
                        <ul>Par page :
                            {% if param is null %}
                                <a href="{{ path(vue,  pathReq | merge({"rowsPerPage":5}) ) }}">5</a>,
                                <a href="{{ path(vue,  pathReq | merge({"rowsPerPage":10}) ) }}">10</a>,
                                <a href="{{ path(vue,  pathReq | merge({"rowsPerPage":20}) ) }}">20</a>,
                                <a href="{{ path(vue,  pathReq | merge({"rowsPerPage":50}) ) }}">50</a>,
                                <a href="{{ path(vue,  pathReq | merge({"rowsPerPage":100}) ) }}">100</a>
                            {% else %}
                                <a href="{{ path(vue, {'id': param}, pathReq | merge({"rowsPerPage":5}) ) }}">5</a>,
                                <a href="{{ path(vue, {'id': param}, pathReq | merge({"rowsPerPage":10}) ) }}">10</a>,
                                <a href="{{ path(vue, {'id': param}, pathReq | merge({"rowsPerPage":20}) ) }}">20</a>,
                                <a href="{{ path(vue, {'id': param}, pathReq | merge({"rowsPerPage":50}) ) }}">50</a>,
                                <a href="{{ path(vue, {'id': param}, pathReq | merge({"rowsPerPage":100}) ) }}">100</a>
                            {% endif %}
                        </ul>
                        <ul class="pagination pagination-lg pager" id="myPager"></ul>
                    </div>

                </div>
            </div>
            {% else %}
                <div class="text-warning">Aucune vente ne correspond à votre requête, veuillez lancer une nouvelle recherche.</div>
            {% endif %}
        </div>
        <div id="Carte" class="tabcontent">
            {% if ventes is not empty %}
                <div id="mapid"></div>
            {% else %}
                <div class="text-warning">Aucune vente ne correspond à votre requête, veuillez lancer une nouvelle recherche.</div>
            {% endif %}
        </div>
    </section>
{% endblock %}
