{# {# version 1.00, date 08/09/2016, auteur Julie Pain #}
{% extends "InterventionBundle::layout.html.twig" %}

{% block title %}

    Consulter un établissement - {{ parent() }}

{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('vendor/leaflet/dist/leaflet.css') }}" />
    <style>
        #mapid { height: 380px; }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}

    <script src="{{ asset('vendor/pdfmake/build/pdfmake.min.js') }}"></script>
    <script src="{{ asset('vendor/pdfmake/build/vfs_fonts.js') }}"></script>
    <script src="{{ asset('vendor/leaflet/dist/leaflet.js') }}"></script>
    <script src="{{ asset('vendor/turfjs/turf.min.js') }}"></script>
    <script type="application/javascript">

        {% if etablissement.adresse.geolocalisation is not null %}
            var lat = {{ etablissement.adresse.geolocalisation|split('(')[1]|split(' ')[0] }};
            var lon = {{ etablissement.adresse.geolocalisation|split(' ')[1]|split(')')[0] }};
            var mymap = L.map('mapid').setView([lon, lat], 15);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);
            var marker = L.marker([lon, lat]).addTo(mymap);
            marker.bindPopup("<b>{{ etablissement.nom }}</b><br>{{ etablissement.adresse.ville.nom }}").openPopup();
        {% else %}
            $("#mapid").html("Les coordonnées de l'établissement ne sont pas renseignées.");
        {% endif %}
    </script>
    <script>

        function imprimer(){

            var emails = "";
            {% if etablissement.emails is not empty %}
                {% for email in etablissement.emails %}
                    emails+="{{ email }} "
                {% endfor %}
            {% else %}
                emails="-"
            {% endif %}
            var docDefinition = {
                content: [
                    {text: "Fiche d'Établissement\n\n", style: ['header']},
                    {text: "Nom: {{ etablissement.nom }}\n\n", style: ['body'] },
                    {text: "Téléphone: {{ etablissement.telFixe }}\n\n", style: ['body'] },
                    {text: "Emails:"+emails+'\n\n', style: ['body'] },
                    {text: "Adresse: {{ etablissement.adresse.adresse }} {{ etablissement.adresse.complement }}, {{ etablissement.adresse.codePostal.code }} {{ etablissement.adresse.ville.nom }}\n\n", style: ['body']},
                    {text: "Interventions demandées:", style: ['body'] },
                    {% if listeInterventionsDemandeesNonRealisees is not empty  %}
                        {% for intervention in listeInterventionsDemandeesNonRealisees %}
                            {% if intervention.plaidoyer %}
                    {text: "    Action éducative - {{ intervention.etablissement.adresse.ville.nom }}\n\n", style: ['body'] },
                            {% elseif intervention.frimousse %}
                    {text: "    Frimousse - {{ intervention.etablissement.adresse.ville.nom }}\n\n", style: ['body'] },
                            {% else %}
                    {text: "    Autre intervention - {{ intervention.etablissement.adresse.ville.nom }}\n\n", style: ['body'] },
                            {% endif %}
                        {% endfor %}
                    {% else %}
                    {text: "\t\tAucune\n\n", style: ['body'] },
                    {% endif %}
                    {text: "Interventions réalisées:", style: ['body'] },
                    {% if listeInterventionsRealisees is not empty  %}
                    {% for intervention in listeInterventionsRealisees %}
                        {% if intervention.plaidoyer %}
                    {text: "Action éducative - {{ intervention.etablissement.adresse.ville.nom }}, {{ intervention.dateIntervention|date('d-m-Y') }} {{ intervention.heure }}\n\n", style: ['body'] },
                            {% elseif intervention.frimousse %}
                    {text: "Frimousse - {{ intervention.etablissement.adresse.ville.nom }}, {{ intervention.dateIntervention|date('d-m-Y') }} {{ intervention.heure }}\n\n", style: ['body'] },
                            {% else %}
                    {text: "Autre intervention - {{ intervention.etablissement.adresse.ville.nom }}, {{ intervention.dateIntervention|date('d-m-Y') }} {{ intervention.heure }}\n\n", style: ['body'] },
                            {% endif %}
                    {% endfor %}
                    {% else %}
                    {text: "Aucune\n\n", style: ['body'] },
                    {% endif %}
                    {% if etablissement.contacts is not empty%}
                        {text: "Contacts:\n\n", style: ['body'] },
                        {% for contact in etablissement.contacts %}
                            {text: "Contact 1:\n\n", style: ['body'] },
                            {text: "Nom: {{ contact.nom |capitalize }}\n\n", style: ['body'] },
                            {text: "Prenom: {{ contact.prenom |capitalize }}\n\n", style: ['body'] },
                            {text: "Tel. Fixe: {{ contact.telFixe }}\n\n", style: ['body'] },
                            {text: "Tel. Portable: {{ contact.telPortable }}\n\n", style: ['body'] },
                        {% endfor %}
                    {% endif %}
                ],
                styles: {
                    header: {
                        fontSize: 14,
                        alignment: 'center'
                    },
                    body: {
                        fontSize: 9,
                        alignment: 'left'
                    }
                }
            };
            pdfMake.createPdf(docDefinition).open();
        }
    </script>

{% endblock %}

{% block body %}

<div class="container">
    <div class="row">
        <section class="jumbotron col-sm-12 col-lg-8 col-lg-offset-2">
            <div class="infoPrincip">
                <div class="row">
                    <h2 class="col-lg-9 titre">Etablissement</h2><br><br>
                    <h4 class="col-lg-9">
                        {% if etablissement.typeEnseignement %}
                            Enseignement
                        {% elseif etablissement.typeCentre %}
                            Centre de Loisirs
                        {% else %}
                            Autre établissement
                    {% endif %}
                    </h4>
                    <img src="{{ asset('img/logo-gris.png') }}" class="logoGris" alt="logo Unicef">
                </div>
                <hr>
                <div class="row">
                    <div class="col-sm-6">
                        <dl class="dl-horizontal">
                            <div class="col-sm-4 col-xs-12">
                                <dt>
                                    <span class="glyphicon glyphicon-user"></span> &nbsp Nom :
                                </dt>
                            </div>

                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">
                                <em>{% if etablissement.nom is not empty %}
                                    {{ etablissement.nom }}
                                    {% else %}
                                    -
                                    {% endif %}
                                </em>
                            </div>

                            <div class="col-sm-4 col-xs-12">
                                <dt>
                                    <span class="glyphicon glyphicon-earphone"></span> &nbsp Téléphone :
                                </dt>
                            </div>
                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">
                                <em>{% if etablissement.telFixe is not empty %}
                                        {{ etablissement.telFixe }}
                                    {% else %}
                                        -
                                    {% endif %}</em>
                            </div>
                            <div class="col-sm-4 col-xs-12">
                                <dt>
                                    <span class="glyphicon glyphicon-envelope"></span>&nbsp E-mails :
                                </dt>
                            </div>
                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">


                                {% if etablissement.emails is not empty %}
                                    <ul class="list-group col-sm-12 " style="list-style-type: none;">
                                        {% for email in etablissement.emails %}
                                           <li> <em>{{ email }}</em> </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <div class="col-sm-7">
                                        -
                                    </div>
                                {% endif %}
                            </div>


                            <div class="col-sm-4 col-xs-12">
                                <dt>
                                    <span class="glyphicon glyphicon-home"></span> &nbsp Adresse :
                                </dt>
                            </div>
                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">
                                <em> {{ etablissement.adresse.adresse }} {{ etablissement.adresse.complement }}, {{ etablissement.adresse.codePostal.code }} {{ etablissement.adresse.ville.nom }} <br/>


                                </em>
                            </div>

                            {{ block('contenu') }}
                        </dl>
                    </div>
                    <div class="col-sm-6 col-xs-12">
                        <div id="mapid"></div>
                    </div>
                </div>
            </div>
        </section>
    </div>
    {% if is_granted('ROLE_ADMIN') %}
    <div class="row">
        <div class="buttons">
            <a href="{{ path("etablissement_admin_edit", {'id': etablissement.id}) }}" class="btn btn-primary"><span class="glyphicon glyphicon-pencil"> </span>&nbsp Modifier</a>
            <button type="button" class="btn btn-primary" onclick="imprimer()" ><span class="glyphicon glyphicon-print"></span> Imprimer La fiche descriptive de l'établissement</button>
            <a href="{{ path("vente_list", {'etablissement': etablissement.id}) }}" class="btn btn-primary"><span class="glyphicon glyphicon-list"> </span> Consulter les ventes associées</a>
            <a href="{{ path("vente_add", {'etablissement': etablissement.id}) }}" class="btn btn-primary"><span class="glyphicon glyphicon-euro"> </span> Ajouter une vente</a>
            <a href="{{ path("etablissement_admin_delete", {'id': etablissement.id}) }}" class="btn btn-danger" onclick="return confirm('Souhaitez vous vraiment supprimer l\'établissment {{ etablissement.nom }} ?')"><span class="glyphicon glyphicon-trash">  </span>&nbsp Supprimer </a>
        </div>
    </div>
    {% endif %}
    <div class="row">
        <div class="col-sm-12 col-sm-12 col-lg-8 col-lg-offset-2 infoContainer">
            <div class="col-sm-4 containerOne">
                <div class="circle circleOne">
                    <img src="{{ asset('img/bell.png') }}" alt="bell" >
                </div>
                <h3>Interventions demandées</h3>
                <div class="row">
                    {% if listeInterventionsDemandeesNonRealisees is not empty  %}
                        <div class="scrollspy-example col-lg-offset-1 col-sm-11" data-offset="0" data-target="#navbar-example" data-spy="scroll" style="
                                    height: 200px;
                                    overflow: auto;
                                    position: relative;
                                    border:1px solid #cccccc;
                                    padding:10px;
                                 ">
                            {% for intervention in listeInterventionsDemandeesNonRealisees %}
                                <a href="{{ path('intervention_view', {'id': intervention.id})  }}" style="color:white">
                                    {% if intervention.plaidoyer %}
                                        Action éducative -
                                    {% elseif intervention.frimousse %}
                                        Frimousse -
                                    {% else %}
                                        Autre intervention -
                                    {% endif %}
                                    {{ intervention.etablissement.adresse.ville.nom }}
                                    </br>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="col-lg-offset-1 col-sm-7">
                            Aucune
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-sm-4 containerTwo">
                <div class="circle circleTwo">
                    <img src="{{ asset('img/speech-bubbles.png') }}" alt="speech bubble">
                </div>
                <h3>Interventions réalisées</h3>
                <div class="row">
                    {% if listeInterventionsRealisees is not empty  %}
                        <div class="scrollspy-example col-lg-offset-1 col-sm-11" data-offset="0" data-target="#navbar-example" data-spy="scroll" style="
                                    height: 200px;
                                    overflow: auto;
                                    position: relative;
                                    border:1px solid #cccccc;
                                    padding:10px;">                            {% for intervention in listeInterventionsRealisees %}
                                <a href="{{ path('intervention_view', {'id': intervention.id}) }}"  style="color:white">
                                    {% if intervention.plaidoyer %}
                                        Action éducative -
                                    {% elseif intervention.frimousse %}
                                        Frimousse -
                                    {% else %}
                                        Autre intervention -
                                    {% endif %}
                                    {{ intervention.etablissement.adresse.ville.nom }}
                                    </br>
                                </a>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="col-lg-offset-1 col-sm-7">
                            Aucune
                        </div>
                    {% endif %}
                </div>
            </div>
            <div class="col-sm-4 containerThree">
                <div class="circle circleThree">
                    <img src="{{ asset('img/telephone.png') }}" alt="phone" >
                </div>
                <h3>Contacts</h3>
                <div class="row">
                            {% if etablissement.contacts is not empty%}
                                {% for contact in etablissement.contacts %}
                                    <div class="well col-lg-offset-1 col-sm-12 col-xs-12">
                                        <dl class="dl-horizontal">
                                            <div class="col-sm-6 col-xs-12">
                                                <dt>
                                                    Nom:
                                                </dt>
                                            </div>

                                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">
                                                <em>{% if contact.nom is not empty %}
                                                    {{ contact.nom |capitalize }}
                                                    {% else %}
                                                    -
                                                    {% endif %}
                                                </em>
                                            </div>

                                            <div class="col-sm-6 col-xs-12">
                                                <dt>
                                                    Prénom :
                                                </dt>
                                            </div>
                                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">
                                                <em>
                                                    <em>{% if contact.prenom is not empty %}
                                                            {{ contact.prenom |capitalize }}
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </em>
                                                </em>
                                            </div>
                                            <div class="col-sm-6 col-xs-12">
                                                <dt>
                                                    Tel fixe :
                                                </dt>
                                            </div>
                                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">
                                                <em>{% if contact.telFixe is not empty %}
                                                        {{ contact.telFixe }}
                                                    {% else %}
                                                        -
                                                    {% endif %}</em>
                                            </div>


                                            <div class="col-sm-6 col-xs-12">
                                                <dt>
                                                    Tel portable :
                                                </dt>
                                            </div>
                                            <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-0">
                                                <em>{% if contact.telPortable is not empty %}
                                                        {{ contact.telPortable }}
                                                    {% else %}
                                                        -
                                                    {% endif %}</em>
                                            </div>

                                        </dl>
                                    </div>
                                {% endfor %}
                            {% else %}
                                &nbsp &nbsp &nbsp <em>Aucun contact</em>
                            {% endif %}

                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}
