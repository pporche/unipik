{# version 1.00, date 13/05/2016, auteur Matthieu Martins-Baltar #}
{% extends "InterventionBundle::layout.html.twig" %}

{% block title %}

    Consulter une intervention - {{ parent() }}

{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <link rel="stylesheet" href="{{ asset('vendor/leaflet/dist/leaflet.css') }}" />
    <style>
        #mapid { height: 380px; }

        .alert-success{
            margin-top:30px;
        }
    </style>
{% endblock %}

{% block javascripts %}
    {{ parent() }}
    <script src="{{ asset("vendor/typeahead.js/dist/typeahead.jquery.js") }}"></script>
    <script src="{{ asset("vendor/typeahead.js/dist/bloodhound.js") }}"></script>
    <script src="{{ asset('vendor/leaflet/dist/leaflet.js') }}"></script>
    <script>

        {% if intervention.etablissement.adresse.geolocalisation is not null %}
            var lat = {{ intervention.etablissement.adresse.geolocalisation|split('(')[1]|split(' ')[0] }};
            var lon = {{ intervention.etablissement.adresse.geolocalisation|split(' ')[1]|split(')')[0] }};
            var mymap = L.map('mapid').setView([lon, lat], 15);
            L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpandmbXliNDBjZWd2M2x6bDk3c2ZtOTkifQ._QA7i5Mpkd_m30IGElHziw', {
                maxZoom: 18,
                attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
                '<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery © <a href="http://mapbox.com">Mapbox</a>',
                id: 'mapbox.streets'
            }).addTo(mymap);
            var marker = L.marker([lon, lat]).addTo(mymap);
            marker.bindPopup("<b>{{ intervention.etablissement.nom }}</b><br>{{ intervention.etablissement.adresse.ville.nom }}").openPopup();
        {% else %}
            $("#mapid").html("Les coordonnées de l'établissement ne sont pas renseignées.");
        {% endif %}

        {% if intervention.benevole %}
        $("#attribueA").text("Attribuée à {{ intervention.benevole.prenom }} {{ intervention.benevole.nom }}");
        {% endif %}


        function desattributeIntervention(event, id) {
            $.post("{{ path('intervention_self_desattribute') }}", {'id': id},
                function (data, status) {
                    $(event).attr('class', 'btn btn-primary');
                    $(event).text('S\'attribuer l\'intervention');
                    $(event).attr("onclick", "attributeIntervention(this, " + id + ")");
                    $("#attribueA").text("");
                    $("#boutonModifier").toggle();
                });
        }

        function desattributeInterventionAdmin(event, id) {
            $.post("{{ path('intervention_self_desattribute') }}", {'id': id},
                function (data, status) {
                    $(event).attr('class', 'btn btn-primary');
                    $(event).text('Attribuer l\'intervention a');
                    $(event).attr("onclick", "sendIdToModal(" + id + ")");
                    $(event).attr("data-target", "#myModal");
                    $(event).attr("data-toggle", "modal");
                    $("#attribueA").text("");

                });
        }

        function attributeIntervention(event, id) {
            $.post("{{ path('intervention_self_attribute') }}", {'id': id},
                function (data, status) {
                    $(event).attr('class', 'btn btn-danger');
                    $(event).text('Se désattribuer l\'intervention');
                    $(event).attr("onclick", "desattributeIntervention(this, " + id + ")");
                    $("#attribueA").text("Attribuée à {{ user.prenom }} {{ user.nom }}");
                    $("#boutonModifier").toggle();
                });
        }

        function realisationIntervention(event, id) {
            $.post("{{ path('intervention_done') }}", {'id': id},
                function (data, status) {
                    $(event).hide();
                    {% if intervention.benevole==user %}
                        $("#realiseeMoi").html("&nbsp &nbsp Réalisée par moi <span class='glyphicon glyphicon-ok'></span>");
                    {% elseif intervention.benevole %}
                        $("#realisee").html("&nbsp &nbsp Réalisée par {{ intervention.benevole.prenom }} <span class='glyphicon glyphicon-ok'></span>");
                    {% endif %}
                    $('button[name=desattribution]').hide();
                    {%  if not is_granted('ROLE_ADMIN') %}
                        $("#boutonModifier").toggle();
                    {% else %}
                        $("#attribueA").hide();
                    {% endif %}
                });
        }

        function attributeInterventionAdmin(event, username, id) {
            username = parseUsername(username);
            $.post("{{ path('intervention_attribute') }}", {'username': username, 'id': id},
                function (data, status) {
                    $("button[data-target='#myModal']").attr('class', 'btn btn-danger');
                    $("button[data-target='#myModal']").text('Désattribuer l\'intervention');
                    $("button[data-target='#myModal']").attr("onclick", "desattributeInterventionAdmin(this, " + id + ")");
                    $("button[data-target='#myModal']").removeAttr("data-target");
                    $("button[data-target='#myModal']").removeAttr("data-toggle");
                    $("#attribueA").text("Attribuée à " + data.prenom + " " + data.nom);
                });
        }

        function parseUsername(username){
            var regexUsername = /\((.*?)\)/;
            username = regexUsername.exec(username)[0].substring(1);
            return username.substring(0,username.length-1);
        }

        function sendIdToModal(id) {
            $("#attribution_idIntervention").attr("value", id);
        }

        var benevoles = new Bloodhound({
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('value'),
            queryTokenizer: Bloodhound.tokenizers.whitespace,
            {#//prefetch: '{{ path("architecture_ville_autocomplete") }}',#}
            remote: {
                url: '{{ path("user_admin_benevole_autocomplete") }}?term=%QUERY',
                wildcard: '%QUERY'
            }
        });

        $('#attribution_benevole').typeahead(null, {
            name: 'benevoles',
            source: benevoles,
            limit: 50
        });

        $('#attribuerModal').click(function () {
            $('#myModal').modal('hide');
        });


    </script>

{% endblock %}

{% block body %}

    <div class="btn-group">
        <form action="{{ path( 'intervention_list') }}">
            <input type="submit" class="btn btn-primary" value="Retour à la liste d'interventions" style="margin-top: 50px; display: block;">
        </form>
    </div>
        <div class="row">
            <section class="jumbotron col-sm-12 col-sm-12 col-lg-8 col-lg-offset-2">
                <div class=" infoPrincip">
                    <div class="row">
                        <h2 class="col-lg-6 titre">
                            Intervention
                        </h2>
                        <div class="col-lg-6">
                            {% if (date("now")>=(intervention.dateIntervention) and not (intervention.realisee) and (intervention.benevole)) %}
                                {% if intervention.benevole==user or is_granted('ROLE_ADMIN') %}
                                    <button name="realisation" type="button" class="btn btn-primary"
                                            onclick="realisationIntervention(this, {{ intervention.id }})">
                                        Marquer comme réalisée
                                    </button>
                                {% endif %}
                            {% endif %}
                        </div>

                        <h4 class="col-lg-12">
                            {% if intervention.plaidoyer %}
                                Action éducative
                            {% elseif intervention.frimousse %}
                                Frimousse
                            {% else %}
                                Autre intervention
                            {% endif %}
                        </h4>
                        {% if intervention.realisee %}
                            {% if intervention.benevole==user %}
                                <p class="text-success" id="realiseeMoi">&nbsp &nbsp Réalisée par moi <span
                                        class="glyphicon glyphicon-ok"></span></p>
                            {% else %}
                                <p class="text-success" id="realisee">&nbsp &nbsp Réalisée
                                    par {{ intervention.benevole.prenom }} <span class="glyphicon glyphicon-ok"></span>
                                </p>
                            {% endif %}
                        {% elseif intervention.benevole %}
                            <p class="text-success" id="realiseeMoi"></p>
                            <p class="text-success" id="realisee"></p>
                            {% if user==intervention.benevole %}
                                <em>&nbsp &nbsp  <strong>Attribuée à vous</strong></em>
                            {% else %}
                                <h4 class="col-lg-12" id="attribueA">Attribuée
                                    à {{ intervention.benevole.prenom }} {{ intervention.benevole.nom }}</h4>
                                {% if is_granted('ROLE_ADMIN') %}
                                    <button name="desattribution" type="button" class="btn btn-danger"
                                            onclick="desattributeInterventionAdmin(this, {{ intervention.id }})">
                                        Désattribuer l'intervention
                                    </button>
                                {% endif %}
                            {% endif %}
                        {% else %}
                            {% if is_granted('ROLE_ADMIN') %}
                                <button id="btnAttribuerAdmin" type="button" class="btn btn-primary" data-toggle="modal"
                                        data-target="#myModal" onclick="sendIdToModal({{ intervention.id }})">
                                    Attribuer l'intervention à
                                </button>
                            {% else %}
                                <button name="attribution" type="button" class="btn btn-primary"
                                        onclick="attributeIntervention(this, {{ intervention.id }})">
                                    S'attribuer l'intervention
                                </button>
                            {% endif %}

                            {% if intervention.realisee %}
                                {% if intervention.benevole %}
                                    <h4> Réalisé par { intervention.benevole.nom } </h4>
                                {% endif %}
                            {% endif %}
                        {% endif %}

                        <img src="{{ asset('img/logo-gris.png') }}" class="logoGris" alt="logo gris">
                    </div>
                    <hr style="margin-top: 50px;">
                    <div class="row">
                        <div class="col-sm-6">
                            <dl class="dl-horizontal">
                                <div class="col-sm-5 col-xs-12  col-md-4">
                                    <dt>
                                        <span class="glyphicon glyphicon-globe"></span> &nbsp Etablissement:
                                    </dt>
                                </div>

                                <div class="col-sm-5 col-xs-offset-1 col-xs-11 col-md-7">
                                    <a href="{{ path ('etablissement_view', {'id': intervention.etablissement.id}) }}">
                                        <em>
                                            {% if intervention.etablissement.nom == "" or intervention.etablissement.nom == NULL %}
                                                Etablissement à {{ intervention.etablissement.adresse.ville.nom }}
                                            {% else %}
                                                {{ intervention.etablissement.nom }} à {{ intervention.etablissement.adresse.ville.nom }}
                                            {% endif %} </em> </a>
                                </div>
                                <br>
                                <div class="col-sm-5 col-xs-12  col-md-4">
                                    <dt>
                                        <span class="glyphicon glyphicon-calendar"></span> &nbsp Date:
                                    </dt>
                                </div>
                                <div class="col-sm-5 col-xs-offset-1 col-xs-11 col-md-7">
                                    <em>{% if intervention.dateIntervention is empty %}
                                            --:--
                                        {% else %}
                                            {{ intervention.dateIntervention|date('d-m-Y') }}
                                        {% endif %}
                                    </em>
                                </div>
                                <div class="col-sm-5 col-xs-12  col-md-4">
                                    <dt>
                                        <span class="glyphicon glyphicon-time"></span> &nbsp Heure:
                                    </dt>
                                </div>
                                <div class="col-sm-5 col-xs-offset-1 col-xs-11 col-md-7">
                                    <em>{% if intervention.heure is empty %}
                                            --:--
                                        {% else %}
                                            {{ intervention.heure }}
                                        {% endif %}
                                    </em>
                                </div>


                                <div class="col-sm-5 col-xs-12  col-md-4">
                                    <dt>
                                        <span class="glyphicon glyphicon-circle-arrow-right"></span> &nbsp Lieu:
                                    </dt>
                                </div>
                                <div class="col-sm-5 col-xs-offset-1 col-xs-11 col-md-7">
                                    <em>{% if intervention.lieu is empty %}
                                            -
                                        {% else %}
                                            {{ intervention.lieu | capitalize }}
                                        {% endif %}</em>
                                </div>

                                <div class="col-sm-5 col-xs-12  col-md-4">
                                    <dt>
                                        <span class="glyphicon glyphicon-user"></span> &nbsp Nb de participants:
                                    </dt>
                                </div>
                                <div class="col-sm-5 col-xs-offset-1 col-xs-11 col-md-7">
                                    <em>{% if intervention.nbPersonne is empty %}
                                            -
                                        {% else %}
                                            {{ intervention.nbPersonne }}
                                        {% endif %}</em>
                                </div>
                                <div class="col-sm-5 col-xs-12  col-md-4">
                                    <dt>
                                        <span class="glyphicon glyphicon-home"></span> &nbsp Adresse :
                                    </dt>
                                </div>
                                <div class="col-sm-5 col-xs-offset-1 col-xs-11 col-md-7">
                                        <div>{{  intervention.etablissement.adresse.adresse }}</div>
                                        {%  if intervention.etablissement.adresse.complement %}
                                        <div>{{ intervention.etablissement.adresse.complement }}</div>
                                        {% endif %}
                                       <div> {{ intervention.etablissement.adresse.codePostal.code }} {{ intervention.etablissement.adresse.ville.nom }}</div>

                                </div>
                                {{ block('contenu') }}
                            </dl>
                        </div>
                        <div class="col-sm-6 col-xs-12">
                            <div id="mapid"></div>
                        </div>
                    </div>


                </div>
            </section>
        </div>
        <div class="row">
            <div class="buttons">

                <a href="{{ path("demande_view", {'id': intervention.id}) }}" class="btn btn-primary">
                    <span class="glyphicon glyphicon-eye-open"> </span>&nbsp Demande Associée
                </a>
                {% if (is_granted('ROLE_ADMIN') or ((intervention.benevole==user)) and not (intervention.realisee)) %}
                    <a id="boutonModifier" href="{{ path("intervention_edit", {'id': intervention.id}) }}"
                       class="btn btn-primary">
                        <span class="glyphicon glyphicon-pencil"></span>&nbsp Modifier
                    </a>
                {% endif %}
                {% if intervention.niveauFrimousse %}
                    <a href="{{ path("vente_list", {'intervention': intervention.id}) }}" class="btn btn-primary">
                        <span class="glyphicon glyphicon-list"> </span> Consulter les ventes associées
                    </a>
                    <a href="{{ path("vente_add", {'intervention': intervention.id}) }}" class="btn btn-primary">
                        <span class="glyphicon glyphicon-euro"> </span> Ajouter une vente
                    </a>
                {% endif %}
                {% if is_granted('ROLE_ADMIN') %}
                    <a href="{{ path("intervention_admin_delete", {'id': intervention.id}) }}" class="btn btn-danger"
                       onclick="return confirm('Souhaitez vous vraiment supprimer cette intervention ?')">
                        <span class="glyphicon glyphicon-trash"> </span>&nbsp Supprimer
                    </a>
                {% endif %}
            </div>
        </div>
        <div class="row">
            <div class="col-sm-12 col-sm-12 col-lg-8 col-lg-offset-2 infoContainer">
                <div class="col-sm-3 containerOne">
                    <div class="circle circleOne">
                        <img src="{{ asset('img/bell.png') }}" alt="bell">
                    </div>
                    <!-- Si { intervention.remarques!=null } -->
                    <h3>Remarques : </h3>
                    <div class="row">
                        <div class="scrollspy-example col-lg-offset-1 col-sm-7" data-offset="0"
                             data-target="#navbar-example" data-spy="scroll" style="
                            height: 200px;
                            overflow: auto;
                            position: relative;
                            border:1px solid #cccccc;
                            padding:10px;">
                            {% if intervention.remarques %}
                                <em>{{ intervention.remarques | capitalize }}</em>
                            {% else %}
                                <em>Aucune</em>
                            {% endif %}
                        </div>
                    </div>
                </div>
                <div class="col-sm-3 containerTwo">
                    <div class="circle circleTwo">
                        <img src="{{ asset('img/location.png') }}" alt="location">
                    </div>
                    <h3>Comité de rattachement : </h3>
                    <div class="row">
                        <ul class="list-group col-lg-offset-1 col-sm-7 ">
                            &nbsp &nbsp &nbsp {% for dep in intervention.comite.departement %}
                                {{ dep.nom }}
                            {% endfor %}
                            Seine-Martime
                        </ul>

                    </div>
                </div>
                <div class="col-sm-3 containerThree">
                    <div class="circle circleThree">
                        <img src="{{ asset('img/telephone.png') }}" alt="telephone">
                    </div>
                    <h3>Contact : </h3>
                    <div class="row">
                        <div class="well col-lg-offset-1 col-sm-12">
                            <dl class="dl-horizontal">
                                {% if (intervention.demande.contact is not empty) %}
                                    <div class="col-sm-4 col-xs-12">
                                        <dt>
                                            Nom :
                                        </dt>
                                    </div>
                                    <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-2">
                                        <em>{% if intervention.demande.contact.nom %}
                                                {{ intervention.demande.contact.nom | capitalize }}
                                            {% else %}
                                                -
                                            {% endif %}</em>
                                    </div>

                                    <div class="col-sm-4 col-xs-12">
                                        <dt>
                                            Prénom :
                                        </dt>
                                    </div>
                                    <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-2">
                                        <em>{% if intervention.demande.contact.prenom %}
                                                {{ intervention.demande.contact.prenom | capitalize }}
                                            {% else %}
                                                -
                                            {% endif %}</em>
                                    </div>
                                    <div class="col-sm-4 col-xs-12">
                                        <dt>
                                            Tel fixe :
                                        </dt>
                                    </div>
                                    <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-2">
                                        <em>{% if intervention.demande.contact.telFixe %}
                                                {{ intervention.demande.contact.telFixe }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </em>
                                    </div>


                                    <div class="col-sm-4 col-xs-12">
                                        <dt>
                                            Tel portable :
                                        </dt>
                                    </div>
                                    <div class="col-sm-6 col-xs-offset-1 col-xs-11 col-sm-offset-2">
                                        <em>{% if intervention.demande.contact.telPortable %}
                                                {{ intervention.demande.contact.telPortable }}
                                            {% else %}
                                                -
                                            {% endif %}</em>
                                    </div>

                                {% else %}
                                    &nbsp &nbsp &nbsp Aucun contact.
                                {% endif %}
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
             aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h4 class="modal-title" id="myModalLabel">Attribuer l'intervention à</h4>
                    </div>
                    <div class="modal-body">
                        {{ form_start(formAttr, {'method': 'post', 'action': path('intervention_list'), 'attr': {'class': 'intervention_list form-sm'}}) }}
                        <h5>Bénévole : {{ form_widget(formAttr.benevole) }}</h5>


                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button id="attribuerModal" type="button" class="btn btn-primary"
                                onclick="attributeInterventionAdmin(this, $('#attribution_benevole').val(), $('#attribution_idIntervention').val())">
                            Attribuer
                        </button>
                    </div>
                    {{ form_end(formAttr) }}
                </div>
            </div>
        </div>

{% endblock %}


